name: "Nix Tests"
on: [push]
jobs:
  Unixes:
    runs-on: ${{ matrix.os }}
    container:
      image: ghcr.io/ledgerhq/lib-ledger-core-build-env/lib-ledger-core-build-env:1.0.2
      credentials:
        username: ${{ secrets.CI_BOT_USERNAME }}
        password: ${{ secrets.CI_BOT_TOKEN }}
    services:
      postgres:
        image: postgres:12
        env:
          POSTGRES_USER: libcore
          POSTGRES_PASSWORD: libcore_pwd
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-20.04, ubuntu-22.04]
    steps:
#    - name: Cancel Previous Runs
#      uses: styfle/cancel-workflow-action@0.9.1
#      with:
#        access_token: ${{ secrets.GITHUB_TOKEN }}
#    - name: Disable Linux TCP/UDP offload
#      if: ${{ startsWith(matrix.os, 'ubuntu') }}
#      run: |
#        sudo ethtool -K eth0 tx off rx off
#    - name: Disable MacOS TCP/UDP offload
#      if: ${{ startsWith(matrix.os, 'macos') }}
#      run: |
#        sudo sysctl -w net.link.generic.system.hwcksum_tx=0
#        sudo sysctl -w net.link.generic.system.hwcksum_rx=0
    - uses: actions/checkout@v2.3.4
      with:
        submodules: 'recursive'
    - name: ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ github.job }}-${{ matrix.os }}
        max-size: "3G"
    - name: Build and run tests
      run: nix/scripts/build_run_tests.sh
      env:
        POSTGRES_HOST: postgres
        POSTGRES_PORT: 5432
        POSTGRES_USER: libcore
        POSTGRES_PASSWORD: libcore_pwd
        POSTGRES_DB: test_db
    - name: Print ccache stats
      run: ccache -s