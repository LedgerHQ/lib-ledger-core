name: "Nix Tests"
on: [push]
jobs:
  Unixes:
    runs-on: ${{ matrix.os }}
    container:
      image: ghcr.io/ledgerhq/lib-ledger-core-build-env/lib-ledger-core-build-env:1.0.2
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-18.04, ubuntu-20.04, macos-latest]
    steps:
    - name: Cancel Previous Runs
      uses: styfle/cancel-workflow-action@0.9.1
      with:
        access_token: ${{ secrets.GITHUB_TOKEN }}
#    - name: Disable Linux TCP/UDP offload
#      if: ${{ startsWith(matrix.os, 'ubuntu') }}
#      run: |
#        sudo ethtool -K eth0 tx off rx off
#    - name: Disable MacOS TCP/UDP offload
#      if: ${{ startsWith(matrix.os, 'macos') }}
#      run: |
#        sudo sysctl -w net.link.generic.system.hwcksum_tx=0
#        sudo sysctl -w net.link.generic.system.hwcksum_rx=0
    - uses: actions/checkout@v2.3.4
      with:
        submodules: 'recursive'
    - name: ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ github.job }}-${{ matrix.os }}
        max-size: "3G"
    - name: Build and run tests
      run: bash nix/scripts/build_run_tests.sh
      env:
        BUILD_LOAD_LIMIT: 2
    - name: Print ccache stats
      run: ccache -s