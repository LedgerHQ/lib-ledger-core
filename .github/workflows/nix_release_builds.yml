name: "Package libcore"
on:
  workflow_dispatch:
  push:
    branches:
      - main
      - package_jar
    tags:
      - '*'
  workflow_run:
    workflows: ["Release libcore"]
    types:
      - completed
jobs:
  libcore_version:
    name: Compute libcore version
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    outputs:
      lib_version: ${{ steps.lib_version.outputs.lib_version }}
      deploy_dynlibs: ${{ steps.lib_version.outputs.deploy_dynlibs }}
      jar_version: ${{ steps.lib_version.outputs.jar_version }}
    steps:
      - uses: actions/checkout@v2.3.4
        with:
          fetch-depth: 0   # By default action fetches only a single commit.
                           # fetch-depth=0 forces to fetch all history and tags.
                           # nix/scripts/export_libcore_version.sh requires git history
                           # https://github.com/actions/checkout/blob/v2.3.4/README.md
      - name: Set version slug and push_to_S3 flags
        id: lib_version
        run: bash nix/scripts/export_libcore_version.sh ${{ github.event.pull_request.head.ref }}
  Build_Release_JNI:
    name: Linux (with JNI)
    uses: ./.github/workflows/tests.yml
    secrets: inherit # pass all secrets
    with:
      buildType: 'Release'
      buildJni: 'ON'
  JAR:
    name: Jar build (MacOS + Linux)
    needs: [libcore_version, Build_Release_JNI]
    runs-on: ubuntu-latest
    steps:
    - name: Cancel Previous Runs
      uses: styfle/cancel-workflow-action@0.9.1
      with:
        access_token: ${{ secrets.GITHUB_TOKEN }}
    - uses: actions/checkout@v2.3.4
      with:
        submodules: 'recursive'
    - uses: cachix/install-nix-action@v14.1
      with:
        nix_path: nixpkgs=https://github.com/NixOS/nixpkgs/archive/5f746317f10f7206f1dbb8dfcfc2257b04507eee.tar.gz
    - run: mkdir -p jar_build/src/main/resources/resources/djinni_native_libs
    - name: Fetch Linux so
      uses: actions/download-artifact@v2
      with:
        name: linux-ubuntu-22.04-libledgercore
        path: jar_build/src/main/resources/resources/djinni_native_libs
    - name: Fetch MacOS dylib
      uses: actions/download-artifact@v2
      with:
        name: macos-libledgercore
        path: jar_build/src/main/resources/resources/djinni_native_libs
    - run: nix-shell --run "bash nix/scripts/build_jar.sh" nix/libcore-jar.nix
      env:
        LIB_VERSION: ${{ needs.libcore_version.outputs.lib_version }}
        GITHUB_TOKEN: ${{ secrets.CI_BOT_TOKEN }}
        JAR_VERSION: ${{ needs.libcore_version.outputs.jar_version }}
    - uses: actions/upload-artifact@v2
      if: ${{ always() }}
      with:
        name: ${{ needs.libcore_version.outputs.lib_version }}-ledger-lib-core.jar
        path: jar_build/artifact/ledger-lib-core.jar
        retention-days: 90
